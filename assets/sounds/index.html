<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Boteco do Belém - Cardápio</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./assets/css/style.css" />
</head>
<body>
<header class="header">
  <div class="logoWrap">
    <img src="./assets/img/logo.png" alt="Boteco do Belém" />
    <div class="headerTitle">Boteco do Belém</div>
  </div>
  <nav class="headerNav">
    <a href="./index.html">Cardápio</a>
    <a href="./comanda.html">Comanda</a>
    <a href="./acompanhamento.html">Acompanhamento</a>
    <a href="./relatorio.html">Relatórios</a>
    <a href="./caixa.html">Caixa</a>
    <a href="./admin.html">Admin</a>
  </nav>
</header>

<div class="wrap">
  <div class="panel">
    <div class="h1">
      Cardápio
      <span class="badge" id="badgeCount">0 itens</span>
    </div>
    <div class="small">Selecione os produtos e mande direto para o WhatsApp.</div>

    <div class="row" style="margin-top:10px">
      <div>
        <span class="label">Categoria</span>
        <select id="fCategoria"></select>
      </div>
      <div>
        <span class="label">Buscar</span>
        <input id="fBusca" placeholder="Ex.: SMASH, COCA..." />
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="cardGrid" id="gridProdutos"></div>
  </div>
</div>

<!-- Carrinho flutuante -->
<div class="cartFloat">
  <button class="cartBtn" id="btnCarrinho">Carrinho (0)</button>
</div>

<div class="cartPanel" id="cartPanel">
  <div class="cartBox">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div class="h2">Seu carrinho</div>
      <button class="btn ghost" type="button" id="btnFecharCarrinho">Fechar</button>
    </div>
    <div id="cartItens"></div>
    <div style="margin-top:10px;font-weight:700" id="cartTotal"></div>

    <div class="panel" style="margin-top:12px">
      <div class="h2">Dados do pedido</div>
      <div class="row" style="margin-top:8px">
        <div>
          <span class="label">Tipo</span>
          <select id="tipoPedido">
            <option value="delivery">Delivery</option>
            <option value="balcao">Retirada/Balcão</option>
          </select>
        </div>
        <div>
          <span class="label">Nome</span>
          <input id="nomeCliente" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <span class="label">Endereço (delivery)</span>
          <input id="enderecoCliente" />
        </div>
        <div>
          <span class="label">Pagamento</span>
          <select id="pagamento">
            <option>Dinheiro</option>
            <option>Pix</option>
            <option>Cartão</option>
          </select>
        </div>
      </div>
      <div style="margin-top:8px">
        <span class="label">Observações</span>
        <textarea id="obsPedido"></textarea>
      </div>
      <div class="btnRow">
        <button class="btn primary" type="button" id="btnEnviarWhats">Enviar no WhatsApp</button>
        <button class="btn ghost" type="button" id="btnLimparCarrinho">Limpar carrinho</button>
      </div>
    </div>
  </div>
</div>

<script src="./assets/js/app.js"></script>
<script>
let PRODUTOS_FILTRADOS = [];
let CONFIG = carregarConfiguracoes();

function preencherFiltroCategorias(){
  const sel = document.getElementById('fCategoria');
  const cats = Array.from(new Set((PRODUTOS||[]).map(p=>String(p.category||'').trim()).filter(Boolean))).sort();
  sel.innerHTML = '<option value="">Todas</option>';
  cats.forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  });
}

function aplicarFiltrosIndex(){
  const cat = (document.getElementById('fCategoria').value || '').trim().toLowerCase();
  const busca = (document.getElementById('fBusca').value || '').trim().toLowerCase();
  let list = (PRODUTOS||[]).slice();

  list = list.filter(p => p.active !== false); // respeita admin

  if(cat){
    list = list.filter(p => String(p.category||'').toLowerCase() === cat);
  }
  if(busca){
    list = list.filter(p=>{
      const code = String(p.code||'').toLowerCase();
      const name = String(p.name||'').toLowerCase();
      const desc = String(p.description||'').toLowerCase();
      return code.includes(busca) || name.includes(busca) || desc.includes(busca);
    });
  }

  PRODUTOS_FILTRADOS = list;
  renderGrid();
}

function renderGrid(){
  const grid = document.getElementById('gridProdutos');
  grid.innerHTML = '';
  document.getElementById('badgeCount').textContent = PRODUTOS_FILTRADOS.length + ' itens';

  PRODUTOS_FILTRADOS.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <div>
        <div class="cardTitle">${p.name || ''}</div>
        <div class="cardDesc">${p.description || ''}</div>
      </div>
      <div class="cardFooter">
        <div class="cardPrice">${formatMoney(p.price)}</div>
        <button class="btn primary" type="button" data-code="${p.code}">Adicionar</button>
      </div>
    `;
    grid.appendChild(div);
  });

  grid.querySelectorAll('button[data-code]').forEach(btn=>{
    btn.addEventListener('click', function(){
      addItemCarrinho(this.getAttribute('data-code'));
      atualizarResumoCarrinho();
    });
  });
}

function atualizarResumoCarrinho(){
  const cart = getCarrinho();
  let total = 0;
  cart.forEach(i => total += i.qtd * i.price);
  const btn = document.getElementById('btnCarrinho');
  btn.textContent = `Carrinho (${cart.reduce((s,i)=>s+i.qtd,0)})`;
}

function abrirCarrinho(){
  const panel = document.getElementById('cartPanel');
  panel.classList.add('show');
  renderCarrinhoDetalhe();
}
function fecharCarrinho(){
  document.getElementById('cartPanel').classList.remove('show');
}

function renderCarrinhoDetalhe(){
  const cart = getCarrinho();
  const wrap = document.getElementById('cartItens');
  const elTotal = document.getElementById('cartTotal');
  wrap.innerHTML = '';

  if(!cart.length){
    wrap.innerHTML = '<div class="small">Seu carrinho está vazio.</div>';
    elTotal.textContent = '';
    return;
  }

  let total = 0;
  cart.forEach(item=>{
    total += item.price * item.qtd;
    const div = document.createElement('div');
    div.style.marginBottom = '6px';
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div>
          <strong>${item.name}</strong><br/>
          <span class="small">${formatMoney(item.price)} x ${item.qtd}</span>
        </div>
        <div>
          <button class="btn ghost" data-act="menos" data-code="${item.code}">-</button>
          <button class="btn ghost" data-act="mais" data-code="${item.code}">+</button>
        </div>
      </div>
    `;
    wrap.appendChild(div);
  });

  elTotal.textContent = 'Total: ' + formatMoney(total);

  wrap.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener('click', function(){
      const act = this.getAttribute('data-act');
      const code = this.getAttribute('data-code');
      let cart = getCarrinho();
      const idx = cart.findIndex(i=>i.code===code);
      if(idx>=0){
        if(act === 'mais') cart[idx].qtd++;
        else{
          cart[idx].qtd--;
          if(cart[idx].qtd<=0) cart.splice(idx,1);
        }
        salvarCarrinho(cart);
        atualizarResumoCarrinho();
        renderCarrinhoDetalhe();
      }
    });
  });
}

function montarTextoWhatsapp(cart,total){
  const tipo = document.getElementById('tipoPedido').value;
  const nome = (document.getElementById('nomeCliente').value || '').trim();
  const end  = (document.getElementById('enderecoCliente').value || '').trim();
  const pag  = document.getElementById('pagamento').value;
  const obs  = (document.getElementById('obsPedido').value || '').trim();

  let txt = '*Pedido - Boteco do Belém*%0A%0A';
  cart.forEach(i=>{
    txt += `- ${i.qtd}x ${i.name} (${formatMoney(i.price)})%0A`;
  });
  txt += `%0A*Total:* ${formatMoney(total)}%0A`;
  txt += `*Tipo:* ${tipo === 'delivery' ? 'Delivery' : 'Retirada/Balcão'}%0A`;
  if(nome) txt += `*Nome:* ${nome}%0A`;
  if(end && tipo==='delivery') txt += `*Endereço:* ${end}%0A`;
  txt += `*Pagamento:* ${pag}%0A`;
  if(obs) txt += `%0A*Obs:* ${encodeURIComponent(obs)}%0A`;

  return txt;
}

async function iniciar(){
  await carregarProdutosBase();
  CONFIG = carregarConfiguracoes();
  preencherFiltroCategorias();
  aplicarFiltrosIndex();
  atualizarResumoCarrinho();
}

document.addEventListener('DOMContentLoaded', ()=>{
  iniciar();

  document.getElementById('fCategoria').addEventListener('change', aplicarFiltrosIndex);
  document.getElementById('fBusca').addEventListener('input', aplicarFiltrosIndex);

  document.getElementById('btnCarrinho').addEventListener('click', abrirCarrinho);
  document.getElementById('btnFecharCarrinho').addEventListener('click', fecharCarrinho);
  document.getElementById('btnLimparCarrinho').addEventListener('click', ()=>{
    salvarCarrinho([]);
    atualizarResumoCarrinho();
    renderCarrinhoDetalhe();
  });

  document.getElementById('btnEnviarWhats').addEventListener('click', ()=>{
    const cart = getCarrinho();
    if(!cart.length){
      alert('Carrinho vazio.');
      return;
    }
    let total = 0;
    cart.forEach(i=> total += i.price * i.qtd);

    // registra pedido (para relatórios/caixa)
    registrarPedido({
      id: Date.now(),
      data: new Date().toISOString(),
      origem: 'app',
      itens: cart,
      total: total,
      tipo: document.getElementById('tipoPedido').value,
      nome: (document.getElementById('nomeCliente').value || '').trim()
    });

    const msg = montarTextoWhatsapp(cart,total);
    const fone = CONFIG.whatsapp || '5549998358251';
    const url = `https://wa.me/${fone}?text=${msg}`;
    window.open(url,'_blank');
  });
});
</script>
</body>
</html>
